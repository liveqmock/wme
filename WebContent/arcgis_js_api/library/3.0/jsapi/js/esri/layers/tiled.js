/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/collections/ArrayList,esri/layers/layer,esri/geometry,dojox/gfx/matrix"],function(_1,_2,_3){_2.provide("esri.layers.tiled");_2.require("dojox.collections.ArrayList");_2.require("esri.layers.layer");_2.require("esri.geometry");_2.require("dojox.gfx.matrix");_2.declare("esri.layers.TiledMapServiceLayer",esri.layers.Layer,{constructor:function(_4,_5){_2.connect(this,"onLoad",this,"_initTiledLayer");this._displayLevels=_5?_5.displayLevels:null;var dh=_2.hitch;this._addImage=dh(this,this._addImage);this._tileLoadHandler=dh(this,this._tileLoadHandler);this._tileErrorHandler=dh(this,this._tileErrorHandler);this._tilePopPop=dh(this,this._tilePopPop);this._cleanUpRemovedImages=dh(this,this._cleanUpRemovedImages);this._fireOnUpdateEvent=dh(this,this._fireOnUpdateEvent);this._transitionEnd=dh(this,this._transitionEnd);},opacity:1,isPNG32:false,_initTiledLayer:function(){var ti=this.tileInfo,_6=ti.lods;this._tileW=ti.width;this._tileH=ti.height;this._normalizedScales=[];var _7=(this.scales=[]),dl=this._displayLevels,fe=this.fullExtent,ul=new esri.geometry.Point(fe.xmin,fe.ymax),lr=new esri.geometry.Point(fe.xmax,fe.ymin),_8=esri.TileUtils.getContainingTileCoords,_9,_a,i,_b=_6.length;for(i=0;i<_b;i++){_a=_6[i];_9=_8(ti,ul,_a);_a.startTileRow=_9.row<0?0:_9.row;_a.startTileCol=_9.col<0?0:_9.col;_9=_8(ti,lr,_a);_a.endTileRow=_9.row;_a.endTileCol=_9.col;if(!dl||_2.indexOf(dl,_a.level)!==-1){_7[i]=_a.scale;this._normalizedScales[i]=_a.scale/ti.dpi;}}this._patchIE=_2.isIE>=6&&_2.isIE<7&&(this.isPNG32||ti.format==="Mixed");},_setMap:function(_c,_d,_e,_f){this._map=_c;var d=(this._div=_2.create("div",null,_d));this._layerIndex=_e;var _10=_c.__visibleDelta,dc=_2.connect,_11=esri._css.names,css={position:"absolute",width:_c.width+"px",height:_c.height+"px",overflow:"visible"};if(_c.navigationMode==="css-transforms"){css[_11.transform]=esri._css.translate(-_10.x,-_10.y);_2.style(d,css);delete css[_11.transform];css[_11.transition]=_11.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease";_2.style((this._active=_2.create("div",null,d)),css);this._active._remove=0;this._passives=[];this._onScaleHandler_connect=dc(_c,"onScale",this,this._onScaleHandler);if(esri.isTouchEnabled){this._standby=[];var _12=this,_13=function(){_12._noDom=1;};this._onPanStartHandler_connect=dc(_c,"onPanStart",_13);this._onZoomStartHandler_connect=dc(_c,"onZoomStart",_13);}}else{css.left=-_10.x+"px";css.top=-_10.y+"px";_2.style(d,css);this._onZoomHandler_connect=dc(_c,"onZoom",this,"_onZoomHandler");}this._onPanHandler_connect=dc(_c,"onPan",this,"_onPanHandler");this._onExtentChangeHandler_connect=dc(_c,"onExtentChange",this,"_onExtentChangeHandler");this._onResizeHandler_connect=dc(_c,"onResize",this,"_onResizeHandler");this._opacityChangeHandler_connect=dc(this,"onOpacityChange",this,"_opacityChangeHandler");this._visibilityChangeHandler_connect=dc(this,"onVisibilityChange",this,"_visibilityChangeHandler");this._tileIds=[];this._tiles=[];this._tileBounds=[];this._ct=null;this._removeList=new _3.collections.ArrayList();this._loadingList=new _3.collections.ArrayList();var _14=this.tileInfo,sr=_14.spatialReference,_15=sr._getInfo();this._wrap=_c.wrapAround180&&sr._isWrappable()&&Math.abs(_15.origin[0]-_14.origin.x)<=_15.dx;if(this._wrap){esri.TileUtils._addFrameInfo(_14,_15);}var _16=_c.extent;if(!this.visible){this._visibilityChangeHandler(this.visible);}if(_16&&_c.loaded){this._onExtentChangeHandler(_16,null,null,_f);}return d;},_unsetMap:function(map,_17){var _18=this._tiles,_19=this._loadingList,img,dd=_2.disconnect;if(_19&&_19.count>0){_19.forEach(function(_1a){img=_18[_1a];if(img){dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;}});_19.clear();this._fireUpdateEnd();}_2.destroy(this._div);this._map=this._layerIndex=this._div=this._standby=null;dd(this._onExtentChangeHandler_connect);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);dd(this._onScaleHandler_connect);dd(this._onLayerReorderHandler_connect);dd(this._onResizeHandler_connect);dd(this._opacityChangeHandler_connect);dd(this._visibilityChangeHandler_connect);dd(this._onPanStartHandler_connect);dd(this._onZoomStartHandler_connect);},_visibilityChangeHandler:function(v){if(v){esri.show(this._div);var map=this._map;if(map.navigationMode==="css-transforms"){this._onScaleHandler_connect=_2.connect(map,"onScale",this,this._onScaleHandler);}else{this._onZoomHandler_connect=_2.connect(map,"onZoom",this,"_onZoomHandler");}this._onPanHandler_connect=_2.connect(map,"onPan",this,"_onPanHandler");this._onExtentChangeHandler(map.extent,null,true);}else{esri.hide(this._div);_2.disconnect(this._onPanHandler_connect);_2.disconnect(this._onZoomHandler_connect);_2.disconnect(this._onScaleHandler_connect);}},_onResizeHandler:function(_1b,_1c,_1d){var css={width:_1c+"px",height:_1d+"px"},ds=_2.style,i;ds(this._div,css);if(this._map.navigationMode==="css-transforms"){if(this._active){ds(this._active,css);}for(i=this._passives.length-1;i>=0;i--){ds(this._passives[i],css);}}},_onExtentChangeHandler:function(_1e,_1f,_20,lod){var map=this._map,i,_21=this._standby,img,_22;if(map._isPanningOrZooming()){return;}if(map.navigationMode==="css-transforms"){if(_20){for(i=this._passives.length-1;i>=0;i--){_22=this._passives[i];_2.style(_22,esri._css.names.transition,"none");if(_22._marked){this._passives.splice(i,1);if(_22.parentNode){_22.parentNode.removeChild(_22);}_2.destroy(_22);}else{if(_22.childNodes.length>0){_22._multiply=_22._multiply?_3.gfx.matrix.multiply(_22._matrix,_22._multiply):_22._matrix;}}}}this._noDom=0;if(_21&&_21.length){for(i=_21.length-1;i>=0;i--){img=_21[i];_2.style(img,"visibility","visible");this._tilePopPop(img);_21.splice(i,1);}}}var _23=true;this._refreshArgs={extent:_1e,lod:lod};if(!this.visible){_23=false;}var _24;if(lod){_24=_2.indexOf(this.scales,lod.scale)===-1;if(this.declaredClass==="esri.layers.WMTSLayer"){var _25=map._params.tileInfo.dpi;var _26=map.width>map.height?map.width:map.height;_24=true;var s1,s2=lod.scale/_25;for(i=0;i<this._normalizedScales.length;i++){s1=this._normalizedScales[i];if(Math.abs((s1-s2)/s1)<(1/_26)){_24=false;break;}}}}else{var _27=map.getLevel(),_28=(_27!==-1)?map._params.tileInfo.lods[_27].scale:-1;_24=(_2.indexOf(this.scales,_28)===-1);}if(_23){var dd=_2.disconnect;if(_24){_23=false;esri.hide(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);dd(this._onScaleHandler_connect);}else{this._fireUpdateStart();esri.show(this._div);dd(this._onPanHandler_connect);dd(this._onZoomHandler_connect);dd(this._onScaleHandler_connect);if(map.navigationMode==="css-transforms"){this._onScaleHandler_connect=_2.connect(map,"onScale",this,this._onScaleHandler);}else{this._onZoomHandler_connect=_2.connect(map,"onZoom",this,"_onZoomHandler");}this._onPanHandler_connect=_2.connect(map,"onPan",this,"_onPanHandler");}}this._rrIndex=0;var ct=esri.TileUtils.getCandidateTileInfo(map,this.tileInfo,_1e),mv=map.__visibleDelta,id;if(!this._ct||ct.lod.level!==this._ct.lod.level||_20){var _29=(ct&&this._ct&&ct.lod.level!==this._ct.lod.level);this._ct=ct;var _2a=this._tiles,_2b=this._tileIds,_2c=this._tileBounds,_2d=this._removeList,_2e,il=_2b.length;this._cleanUpRemovedImages();for(i=0;i<il;i++){id=_2b[i];_2e=_2a[id];_2c[id]=_2b[i]=null;if((map.navigationMode==="css-transforms")&&_29&&_2e.parentNode&&map.fadeOnZoom&&_23){_2e._fadeOut=_29;_2e.parentNode._remove++;}_2d.add(_2e);}if(_20){this._tileIds=[];this._tiles=[];this._tileBounds=[];}}var mx=mv.x,my=mv.y;if(map.navigationMode==="css-transforms"){var css={};css[esri._css.names.transform]=esri._css.translate(mx,my);_2.style(this._div,css);}else{_2.style(this._div,{left:mx+"px",top:my+"px"});}if(_23&&!_24){this.__coords_dx=mx;this.__coords_dy=my;this._updateImages(new esri.geometry.Rect(0,0,mv.width,mv.height));if(this._loadingList.count===0){this.onUpdate();this._fireUpdateEnd();}else{this._fireOnUpdate=true;}}else{this._cleanUpRemovedImages();}var _2f,_30,_31=this._tileW,_32=this._tileH;mv=new esri.geometry.Rect(-mv.x,-mv.y,mv.width,mv.height);for(i=this._tileIds.length-1;i>=0;i--){id=this._tileIds[i];if(id){img=this._tiles[id];_2f=_2.coords(img);_30=new esri.geometry.Rect(_2f.l,_2f.t,_31,_32);if(map.navigationMode==="css-transforms"){_30.x=img._left;_30.y=img._top;}if(mv.intersects(_30)){this._tileBounds[id]=_30;}else{if(this._loadingList.contains(id)){this._tilePopPop(img);}_2.destroy(img);this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}else{this._tileIds.splice(i,1);delete this._tileBounds[id];delete this._tiles[id];}}},_onPanHandler:function(_33,_34){var map=this._map,mv=map.__visibleDelta.offset(_34.x,_34.y);this.__coords_dx=this.__coords_dy=0;if(map.navigationMode==="css-transforms"){var css={};css[esri._css.names.transform]=esri._css.translate(mv.x,mv.y);_2.style(this._div,css);if(!esri.isTouchEnabled){this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}}else{_2.style(this._div,{left:mv.x+"px",top:mv.y+"px"});this._updateImages({x:-mv.x,y:-mv.y,width:mv.width,height:mv.height});}if(this._loadingList.count>0){this._fireUpdateStart();this._fireOnUpdate=true;}},_onScaleHandler:function(mtx,_35){var i,css={},_36=esri._css.names,map=this._map;for(i=this._passives.length-1;i>=0;i--){var _37=this._passives[i];if(_37.childNodes.length===0){this._passives.splice(i,1);_2.destroy(_37);}else{if(_37.style[_36.transition]==="none"){_2.style(_37,_36.transition,_36.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease");}_2.style(_37,_36.transition,_35?"none":(_36.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));_37._matrix=mtx;css[_36.transform]=esri._css.matrix(_37._multiply?_3.gfx.matrix.multiply(mtx,_37._multiply):mtx);_2.style(_37,css);}}if(this._active&&this._active.childNodes.length===0){return;}_2.style(this._active,_36.transition,_35?"none":(_36.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease"));this._active._matrix=mtx;css[_36.transform]=esri._css.matrix(this._active._matrix);_2.style(this._active,css);this._passives.push(this._active);css={position:"absolute",width:map.width+"px",height:map.height+"px",overflow:"visible"};css[_36.transition]=_36.transformName+" "+esri.config.defaults.map.zoomDuration+"ms ease";_2.style((this._active=_2.create("div",null,this._div)),css);this._active._remove=0;if(map.fadeOnZoom){_2.place(this._active,this._div,"first");}},_onZoomHandler:function(_38,_39,_3a){var _3b=_2.coords(this._div);_3a=_3a.offset(-_3b.l,-_3b.t);var _3c,_3d=this._tileW*_39,_3e=this._tileH*_39,_3f=this._tileBounds,_40=this._tiles,es=_2.style;var _41=_2.isIE;if(_41&&_41<8){_2.forEach(this._tileIds,function(id){_3c=_3f[id];es(_40[id],{left:(_3c.x-((_3d-_3c.width)*(_3a.x-_3c.x)/_3c.width))+"px",top:(_3c.y-((_3e-_3c.height)*(_3a.y-_3c.y)/_3c.height))+"px",zoom:_39});});}else{_2.forEach(this._tileIds,function(id){_3c=_3f[id];es(_40[id],{left:(_3c.x-((_3d-_3c.width)*(_3a.x-_3c.x)/_3c.width))+"px",top:(_3c.y-((_3e-_3c.height)*(_3a.y-_3c.y)/_3c.height))+"px",width:_3d+"px",height:_3e+"px"});});}},_updateImages:function(_42){var id,_43=this._tileW,_44=this._tileH,_45=this._ct,lod=_45.lod,_46=_45.tile,off=_46.offsets,_47=_46.coords,cr=_47.row,cc=_47.col,_48=lod.level,_49=this.opacity,_4a=this._tileIds,_4b=this._loadingList,_4c=this._addImage,mId=this._map.id,tId=this.id,rx=_42.x,ry=_42.y,str=lod.startTileRow,etr=lod.endTileRow,stc=lod.startTileCol,etc=lod.endTileCol,_4d=_2.indexOf,r,c,mvx=-_42.x,mvy=-_42.y,_4e=off.x-this.__coords_dx,_4f=off.y-this.__coords_dy,vx=((_43-_4e)+mvx),vy=((_44-_4f)+mvy),_50=Math.ceil,_51=(vx>0)?(vx%_43):((_43-(Math.abs(vx)%_43))),_52=(vy>0)?(vy%_44):((_44-(Math.abs(vy)%_44))),_53=(rx>0)?Math.floor((rx+_4e)/_43):_50((rx-(_43-_4e))/_43),_54=(ry>0)?Math.floor((ry+_4f)/_44):_50((ry-(_44-_4f))/_44),_55=_53+_50((_42.width-_51)/_43),_56=_54+_50((_42.height-_52)/_44),_57,_58,_59,_5a,col,row;if(this._wrap){_57=lod._frameInfo;_58=_57[0];_59=_57[1];_5a=_57[2];}for(col=_53;col<=_55;col++){for(row=_54;row<=_56;row++){r=cr+row;c=cc+col;if(this._wrap){if(c<_59){c=c%_58;c=c<_59?c+_58:c;}else{if(c>_5a){c=c%_58;}}}if(r>=str&&r<=etr&&c>=stc&&c<=etc){id=mId+"_"+tId+"_tile_"+_48+"_"+row+"_"+col;if(_4d(_4a,id)===-1){_4b.add(id);_4a.push(id);_4c(_48,row,r,col,c,id,_43,_44,_49,_46,off);}}}}},_cleanUpRemovedImages:function(){var _5b=this._removeList,dd=_2.destroy,i,_5c=esri._css.names;_5b.forEach(function(img){if(!img._fadeOut){img.style.filter="";img.style.zoom=1;dd(img);}});if(this._map.navigationMode==="css-transforms"){for(i=this._passives.length-1;i>=0;i--){var _5d=this._passives[i];if(_5d.childNodes.length===0){this._passives.splice(i,1);dd(_5d);}else{if(this._map.fadeOnZoom&&!_5d._marked&&(_5d._remove===_5d.childNodes.length)){_2.style(_5d,_5c.transition,"opacity 0.65s");_2.style(_5d,"opacity",0);_5d._marked=1;if(_2.isIE>=10){_5d.addEventListener(_5c.endEvent,this._transitionEnd,false);}else{_5d._endHandle=_2.connect(_5d,_5c.endEvent,this._transitionEnd);}}}}}_5b.clear();},_transitionEnd:function(evt){var _5e=evt.target,idx;if(evt.propertyName!=="opacity"){return;}if(_2.isIE>=10){_5e.removeEventListener(esri._css.names.endEvent,this._transitionEnd,false);}else{_2.disconnect(_5e._endHandle);_5e._endHandle=null;}idx=_2.indexOf(this._passives,_5e);if(idx>-1){this._passives.splice(idx,1);}if(_5e.parentNode){_5e.parentNode.removeChild(_5e);}_2.destroy(_5e);},_addImage:function(_5f,row,r,col,c,id,_60,_61,_62,_63,_64){if(this._patchIE){var div=(this._tiles[id]=_2.create("div"));div.id=id;_2.addClass(div,"layerTile");_2.style(div,{left:((_60*col)-_64.x)+"px",top:((_61*row)-_64.y)+"px",width:_60+"px",height:_61+"px",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+this.getTileUrl(_5f,r,c)+"', sizingMethod='scale')"});if(_62<1){_2.style(div,"opacity",_62);}var _65=div.appendChild(_2.create("div"));_2.style(_65,{opacity:0,width:_60+"px",height:_61+"px"});this._div.appendChild(div);div=null;this._loadingList.remove(id);this._fireOnUpdateEvent();}else{var img=(this._tiles[id]=_2.create("img")),dc=_2.connect;img.id=id;_2.addClass(img,"layerTile");var _66=(_60*col)-_64.x,top=(_61*row)-_64.y,map=this._map,_67=esri._css.names,css={width:_60+"px",height:_61+"px",visibility:"hidden"};if(map.navigationMode==="css-transforms"){css[_67.transform]=esri._css.translate(_66,top);_2.style(img,css);img._left=_66;img._top=top;}else{css.left=_66+"px";css.top=top+"px";_2.style(img,css);}if(_62<1){_2.style(img,"opacity",_62);}img._onload_connect=dc(img,"onload",this,"_tileLoadHandler");img._onerror_connect=dc(img,"onerror",this,"_tileErrorHandler");img._onabort_connect=dc(img,"onabort",this,"_tileErrorHandler");var url=this.getTileUrl(_5f,r,c,img);if(url){img.src=url;}if(map.navigationMode==="css-transforms"){this._active.appendChild(img);}else{this._div.appendChild(img);}img=null;}},getTileUrl:function(_68,row,col){},refresh:function(){var ra=this._refreshArgs;this._onExtentChangeHandler(ra.extent,null,true,ra.lod);},_tilePopPop:function(img){var dd=_2.disconnect;dd(img._onload_connect);dd(img._onerror_connect);dd(img._onabort_connect);img._onload_connect=img._onerror_connect=img._onabort_connect=null;this._loadingList.remove(img.id);this._fireOnUpdateEvent();},_tileLoadHandler:function(evt){var img=evt.currentTarget;if(this._noDom){this._standby.push(img);return;}_2.style(img,"visibility","visible");this._tilePopPop(img);},_tileErrorHandler:function(evt){var img=evt.currentTarget;this.onError(new Error(esri.bundle.layers.tiled.tileError+": "+img.src));_2.style(img,"visibility","hidden");this._tilePopPop(img);},_fireOnUpdateEvent:function(){if(this._loadingList.count===0){this._cleanUpRemovedImages();if(this._fireOnUpdate){this._fireOnUpdate=false;this.onUpdate();this._fireUpdateEnd();}}},setOpacity:function(o){if(this.opacity!=o){this.onOpacityChange(this.opacity=o);}},onOpacityChange:function(){},_opacityChangeHandler:function(_69){var djs=_2.style,i,j,_6a;if(this._map.navigationMode==="css-transforms"){if(this._active){_6a=this._active.childNodes;for(i=_6a.length-1;i>=0;i--){djs(_6a[i],"opacity",_69);}}for(i=this._passives.length-1;i>=0;i--){_6a=this._passives[i].childNodes;for(j=_6a.length-1;j>=0;j--){djs(_6a[j],"opacity",_69);}}return;}_6a=this._div.childNodes;for(i=_6a.length-1;i>=0;i--){djs(_6a[i],"opacity",_69);}}});_2.declare("esri.layers.TileInfo",null,{constructor:function(_6b){this.width=_6b.cols||_6b.width;this.height=_6b.rows||_6b.height;this.dpi=_6b.dpi;this.format=_6b.format;var sr=_6b.spatialReference,ori=_6b.origin;if(sr){sr=(this.spatialReference=new esri.SpatialReference(sr.declaredClass?sr.toJson():sr));}if(ori){ori=(this.origin=new esri.geometry.Point(ori.declaredClass?ori.toJson():ori));if(!ori.spatialReference&&sr){ori.setSpatialReference(new esri.SpatialReference(sr.toJson()));}}var _6c=(this.lods=[]);_2.forEach(_6b.lods,function(lod,i){_6c[i]=new esri.layers.LOD(lod);});}});_2.declare("esri.layers.LOD",null,{constructor:function(_6d){_2.mixin(this,_6d);}});});